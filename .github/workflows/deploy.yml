name: Frontend CI/CD Pipeline

on:
  push:
    branches: [ "main", "test" ]

env:
  IMAGE_NAME: frontend-repo
  DEPLOYMENT_NAME: frontend-app

jobs:
  build_and_push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Determine API URL
        id: vars
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
             echo "API_URL=${{ secrets.PROD_API_URL }}" >> $GITHUB_OUTPUT
          else
             echo "API_URL=${{ secrets.TEST_API_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          build-args: |
            VITE_API_URL=${{ steps.vars.outputs.API_URL }}

  deploy_test:
    name: Deploy to TEST
    needs: build_and_push
    if: github.ref == 'refs/heads/test'
    runs-on: ubuntu-latest
    steps:
      # --- DEBUG MODU: SSH BAĞLANTISINI TEST ETME ADIMI ---
      - name: DEBUG - Manual SSH Connection
        run: |
          echo "SSH Debugging basliyor..."
          mkdir -p ~/.ssh
          
          # Key'i dosyaya yaz
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Key format kontrolü (Sadece başını sonunu gösterir)
          echo "=== KEY KONTROLU ==="
          head -n 2 ~/.ssh/id_rsa
          echo "..."
          tail -n 2 ~/.ssh/id_rsa
          echo "===================="

          # Verbose modda (-vvv) bağlanmayı dene
          # StrictHostKeyChecking=no -> Sunucu fingerprint onayı sormasın
          ssh -vvv -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'EGER BU YAZIYI GORUYORSAN BAGLANTI BASARILI DEMEKTIR'"

  deploy_prod:
    name: Deploy to PRODUCTION
    needs: build_and_push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      # --- DEBUG MODU: SSH BAĞLANTISINI TEST ETME ADIMI ---
      - name: DEBUG - Manual SSH Connection
        run: |
          echo "SSH Debugging basliyor..."
          mkdir -p ~/.ssh
          
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          echo "=== KEY KONTROLU ==="
          head -n 2 ~/.ssh/id_rsa
          echo "..."
          tail -n 2 ~/.ssh/id_rsa
          echo "===================="

          ssh -vvv -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'EGER BU YAZIYI GORUYORSAN BAGLANTI BASARILI DEMEKTIR'"