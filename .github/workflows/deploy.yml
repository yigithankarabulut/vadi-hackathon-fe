name: Frontend CI/CD Pipeline

on:
  push:
    branches: [ "main", "test" ]

env:
  IMAGE_NAME: frontend-repo
  DEPLOYMENT_NAME: frontend-app

jobs:
  # ---------------------------------------------------
  # JOB 1: BUILD & PUSH
  # ---------------------------------------------------
  build_and_push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Determine API URL
        id: vars
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
             echo "API_URL=${{ secrets.PROD_API_URL }}" >> $GITHUB_OUTPUT
          else
             echo "API_URL=${{ secrets.TEST_API_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          build-args: |
            VITE_API_URL=${{ steps.vars.outputs.API_URL }}

  # ---------------------------------------------------
  # JOB 2: DEPLOY TO TEST (Robust Retry)
  # ---------------------------------------------------
  deploy_test:
    name: Deploy to TEST
    needs: build_and_push
    if: github.ref == 'refs/heads/test'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy with Robust Retry
        run: |
          # --- 1. SSH HazÄ±rlÄ±ÄŸÄ± ---
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          HOST="${{ secrets.SSH_HOST }}"
          USER="${{ secrets.SSH_USER }}"
          
          # --- 2. Sunucu KomutlarÄ± ---
          # Kubernetes YAML bloÄŸunu deÄŸiÅŸkenlerin iÃ§ine gÃ¶mÃ¼yoruz
          REMOTE_SCRIPT="
            echo 'ðŸš€ Deploying to TEST environment...'
            
            NAMESPACE='test'
            DOMAIN='test.yigithankarabulut.com'
            IMAGE='${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}'
            DEPLOY_NAME='${{ env.DEPLOYMENT_NAME }}'
            
            # Namespace Kontrol
            kubectl get namespace \$NAMESPACE > /dev/null 2>&1 || kubectl create namespace \$NAMESPACE
            
            # Kubernetes Objeleri (Deployment, Service, Ingress)
            cat <<EOF | kubectl apply -f -
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: \$DEPLOY_NAME
              namespace: \$NAMESPACE
              labels:
                app: \$DEPLOY_NAME
            spec:
              replicas: 1
              selector:
                matchLabels:
                  app: \$DEPLOY_NAME
              template:
                metadata:
                  labels:
                    app: \$DEPLOY_NAME
                spec:
                  containers:
                  - name: frontend
                    image: \$IMAGE
                    ports:
                    - containerPort: 80
            ---
            apiVersion: v1
            kind: Service
            metadata:
              name: \$DEPLOY_NAME-service
              namespace: \$NAMESPACE
            spec:
              selector:
                app: \$DEPLOY_NAME
              ports:
                - protocol: TCP
                  port: 80
                  targetPort: 80
            ---
            apiVersion: networking.k8s.io/v1
            kind: Ingress
            metadata:
              name: \$DEPLOY_NAME-ingress
              namespace: \$NAMESPACE
            spec:
              rules:
              - host: \$DOMAIN
                http:
                  paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: \$DEPLOY_NAME-service
                        port:
                          number: 80
            EOF
            
            # Restart
            kubectl rollout restart deployment/\$DEPLOY_NAME -n \$NAMESPACE
            echo 'âœ… Deployment to TEST complete.'
          "

          # --- 3. RETRY LOOP ---
          set +e # Hatada durmayÄ± engelle
          
          RETRIES=5
          for i in $(seq 1 $RETRIES); do
            echo "Baglanti denemesi $i / $RETRIES..."
            
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa $USER@$HOST "$REMOTE_SCRIPT"
            
            if [ $? -eq 0 ]; then
              echo "ðŸŽ‰ Deployment SUCCESS!"
              exit 0
            fi
            
            echo "âš ï¸ BaÄŸlantÄ± hatasÄ± (Connection Reset). 5 saniye sonra tekrar deneniyor..."
            sleep 5
          done
          
          echo "âŒ $RETRIES deneme baÅŸarÄ±sÄ±z."
          exit 1

  # ---------------------------------------------------
  # JOB 3: DEPLOY TO PROD (Robust Retry)
  # ---------------------------------------------------
  deploy_prod:
    name: Deploy to PRODUCTION
    needs: build_and_push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy with Robust Retry
        run: |
          # --- 1. SSH HazÄ±rlÄ±ÄŸÄ± ---
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          HOST="${{ secrets.SSH_HOST }}"
          USER="${{ secrets.SSH_USER }}"
          
          # --- 2. Sunucu KomutlarÄ± ---
          REMOTE_SCRIPT="
            echo 'ðŸš¨ Deploying to PRODUCTION environment...'
            
            NAMESPACE='prod'
            DOMAIN='yigithankarabulut.com'
            IMAGE='${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}'
            DEPLOY_NAME='${{ env.DEPLOYMENT_NAME }}'
            
            kubectl get namespace \$NAMESPACE > /dev/null 2>&1 || kubectl create namespace \$NAMESPACE
            
            cat <<EOF | kubectl apply -f -
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: \$DEPLOY_NAME
              namespace: \$NAMESPACE
              labels:
                app: \$DEPLOY_NAME
            spec:
              replicas: 2
              selector:
                matchLabels:
                  app: \$DEPLOY_NAME
              template:
                metadata:
                  labels:
                    app: \$DEPLOY_NAME
                spec:
                  containers:
                  - name: frontend
                    image: \$IMAGE
                    ports:
                    - containerPort: 80
            ---
            apiVersion: v1
            kind: Service
            metadata:
              name: \$DEPLOY_NAME-service
              namespace: \$NAMESPACE
            spec:
              selector:
                app: \$DEPLOY_NAME
              ports:
                - protocol: TCP
                  port: 80
                  targetPort: 80
            ---
            apiVersion: networking.k8s.io/v1
            kind: Ingress
            metadata:
              name: \$DEPLOY_NAME-ingress
              namespace: \$NAMESPACE
            spec:
              rules:
              - host: \$DOMAIN
                http:
                  paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: \$DEPLOY_NAME-service
                        port:
                          number: 80
            EOF
            
            kubectl rollout restart deployment/\$DEPLOY_NAME -n \$NAMESPACE
            echo 'âœ… Deployment to PROD complete.'
          "

          # --- 3. RETRY LOOP ---
          set +e
          
          RETRIES=5
          for i in $(seq 1 $RETRIES); do
            echo "Baglanti denemesi $i / $RETRIES..."
            
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa $USER@$HOST "$REMOTE_SCRIPT"
            
            if [ $? -eq 0 ]; then
              echo "ðŸŽ‰ Deployment SUCCESS!"
              exit 0
            fi
            
            echo "âš ï¸ BaÄŸlantÄ± hatasÄ± (Connection Reset). 5 saniye sonra tekrar deneniyor..."
            sleep 5
          done
          
          echo "âŒ $RETRIES deneme baÅŸarÄ±sÄ±z."
          exit 1