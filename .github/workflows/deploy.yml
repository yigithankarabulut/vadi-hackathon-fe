name: Frontend CI/CD (K3s Direct Apply)

on:
  push:
    branches: [ "main", "test" ]

env:
  IMAGE_NAME: frontend-repo

jobs:
  # ---------------------------------------------------
  # JOB 1: BUILD & PUSH
  # ---------------------------------------------------
  build_and_push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set API URL
        id: vars
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
             echo "API_URL=${{ secrets.PROD_API_URL }}" >> $GITHUB_OUTPUT
          else
             echo "API_URL=${{ secrets.TEST_API_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          build-args: |
            VITE_API_URL=${{ steps.vars.outputs.API_URL }}

  # ---------------------------------------------------
  # JOB 2: DEPLOY
  # ---------------------------------------------------
  deploy:
    name: Deploy to ${{ github.ref_name == 'main' && 'Production' || 'Test' }}
    needs: build_and_push
    runs-on: ubuntu-latest
    
    environment: 
      name: ${{ github.ref_name == 'main' && 'production' || 'test' }}
      url: ${{ github.ref_name == 'main' && 'https://yigithankarabulut.com' || 'https://test.yigithankarabulut.com' }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Define variables for the template
            IMAGE_TAG="${{ github.sha }}"
            DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
            
            if [ "${{ github.ref_name }}" == "main" ]; then
              NAMESPACE="prod"
              REPLICAS="2"
              APP_DOMAIN="yigithankarabulut.com"
            else
              NAMESPACE="test"
              REPLICAS="1"
              APP_DOMAIN="test.yigithankarabulut.com"
            fi
            
            echo "Deploying to $NAMESPACE namespace..."
            
            # Ensure Namespace exists
            kubectl get namespace $NAMESPACE > /dev/null 2>&1 || kubectl create namespace $NAMESPACE
            
            # Generate and Apply Manifests directly on the server
            cat <<EOF | kubectl apply -f -
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: frontend-app
              namespace: $NAMESPACE
              labels:
                app: frontend-app
            spec:
              replicas: $REPLICAS
              selector:
                matchLabels:
                  app: frontend-app
              template:
                metadata:
                  labels:
                    app: frontend-app
                spec:
                  containers:
                  - name: frontend
                    image: $DOCKER_USERNAME/frontend-repo:$IMAGE_TAG
                    ports:
                    - containerPort: 80
                    imagePullPolicy: Always
            ---
            apiVersion: v1
            kind: Service
            metadata:
              name: frontend-service
              namespace: $NAMESPACE
            spec:
              selector:
                app: frontend-app
              ports:
                - protocol: TCP
                  port: 80
                  targetPort: 80
            ---
            apiVersion: networking.k8s.io/v1
            kind: Ingress
            metadata:
              name: frontend-ingress
              namespace: $NAMESPACE
            spec:
              rules:
              - host: $APP_DOMAIN
                http:
                  paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: frontend-service
                        port:
                          number: 80
            EOF
            
            # Force Restart to pull new image
            kubectl rollout restart deployment/frontend-app -n $NAMESPACE
            
            echo "Deployment to $NAMESPACE complete."