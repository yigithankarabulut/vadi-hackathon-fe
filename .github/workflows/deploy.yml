name: Frontend CI/CD Pipeline

on:
  push:
    branches: [ "main", "test" ]

env:
  IMAGE_NAME: frontend-repo
  DEPLOYMENT_NAME: frontend-app

jobs:
  build_and_push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Determine API URL
        id: vars
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
             echo "API_URL=${{ secrets.PROD_API_URL }}" >> $GITHUB_OUTPUT
          else
             echo "API_URL=${{ secrets.TEST_API_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          build-args: |
            VITE_API_URL=${{ steps.vars.outputs.API_URL }}

  # ---------------------------------------------------
  # DEPLOY TO TEST
  # ---------------------------------------------------
  deploy_test:
    name: Deploy to TEST
    needs: build_and_push
    if: github.ref == 'refs/heads/test'
    runs-on: ubuntu-latest
    steps:
      - name: Create K8s YAML Locally
        run: |
          # Burada dosyayƒ± LOCALDE olu≈üturuyoruz, Syntax hatasƒ± riski yok.
          cat <<EOF > deploy_test.yaml
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ env.DEPLOYMENT_NAME }}
            namespace: test
            labels:
              app: ${{ env.DEPLOYMENT_NAME }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ${{ env.DEPLOYMENT_NAME }}
            template:
              metadata:
                labels:
                  app: ${{ env.DEPLOYMENT_NAME }}
              spec:
                containers:
                - name: frontend
                  image: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                  ports:
                  - containerPort: 80
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: ${{ env.DEPLOYMENT_NAME }}-service
            namespace: test
          spec:
            selector:
              app: ${{ env.DEPLOYMENT_NAME }}
            ports:
              - protocol: TCP
                port: 80
                targetPort: 80
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: ${{ env.DEPLOYMENT_NAME }}-ingress
            namespace: test
          spec:
            rules:
            - host: test.yigithankarabulut.com
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: ${{ env.DEPLOYMENT_NAME }}-service
                      port:
                        number: 80
          EOF

      - name: Deploy with Robust Retry
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          HOST="${{ secrets.SSH_HOST }}"
          USER="${{ secrets.SSH_USER }}"

          # RETRY LOOP
          set +e
          RETRIES=5
          
          for i in $(seq 1 $RETRIES); do
            echo "Baglanti denemesi $i / $RETRIES..."
            
            # Y√ñNTEM: Dosyayƒ± SSH √ºzerinden aktar ve uygula.
            # cat deploy_test.yaml | ssh ... "cat > /tmp/deploy.yaml && kubectl apply..."
            
            cat deploy_test.yaml | ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa $USER@$HOST "
              cat > /tmp/deploy_frontend_test.yaml;
              kubectl get namespace test > /dev/null 2>&1 || kubectl create namespace test;
              kubectl apply -f /tmp/deploy_frontend_test.yaml;
              kubectl rollout restart deployment/${{ env.DEPLOYMENT_NAME }} -n test;
              rm /tmp/deploy_frontend_test.yaml
            "
            
            if [ $? -eq 0 ]; then
              echo "üéâ Deployment SUCCESS!"
              exit 0
            fi
            
            echo "‚ö†Ô∏è Hata olu≈ütu. 5 saniye sonra tekrar deneniyor..."
            sleep 5
          done
          
          echo "‚ùå $RETRIES deneme ba≈üarƒ±sƒ±z."
          exit 1

  # ---------------------------------------------------
  # DEPLOY TO PROD
  # ---------------------------------------------------
  deploy_prod:
    name: Deploy to PRODUCTION
    needs: build_and_push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Create K8s YAML Locally
        run: |
          # Localde YAML olu≈üturuyoruz
          cat <<EOF > deploy_prod.yaml
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ env.DEPLOYMENT_NAME }}
            namespace: prod
            labels:
              app: ${{ env.DEPLOYMENT_NAME }}
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: ${{ env.DEPLOYMENT_NAME }}
            template:
              metadata:
                labels:
                  app: ${{ env.DEPLOYMENT_NAME }}
              spec:
                containers:
                - name: frontend
                  image: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                  ports:
                  - containerPort: 80
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: ${{ env.DEPLOYMENT_NAME }}-service
            namespace: prod
          spec:
            selector:
              app: ${{ env.DEPLOYMENT_NAME }}
            ports:
              - protocol: TCP
                port: 80
                targetPort: 80
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: ${{ env.DEPLOYMENT_NAME }}-ingress
            namespace: prod
          spec:
            rules:
            - host: yigithankarabulut.com
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: ${{ env.DEPLOYMENT_NAME }}-service
                      port:
                        number: 80
          EOF

      - name: Deploy with Robust Retry
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          HOST="${{ secrets.SSH_HOST }}"
          USER="${{ secrets.SSH_USER }}"

          set +e
          RETRIES=5
          
          for i in $(seq 1 $RETRIES); do
            echo "Baglanti denemesi $i / $RETRIES..."
            
            # Dosyayƒ± sunucuya g√∂nder ve uygula
            cat deploy_prod.yaml | ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa $USER@$HOST "
              cat > /tmp/deploy_frontend_prod.yaml;
              kubectl get namespace prod > /dev/null 2>&1 || kubectl create namespace prod;
              kubectl apply -f /tmp/deploy_frontend_prod.yaml;
              kubectl rollout restart deployment/${{ env.DEPLOYMENT_NAME }} -n prod;
              rm /tmp/deploy_frontend_prod.yaml
            "
            
            if [ $? -eq 0 ]; then
              echo "üéâ Deployment SUCCESS!"
              exit 0
            fi
            
            echo "‚ö†Ô∏è Hata olu≈ütu. 5 saniye sonra tekrar deneniyor..."
            sleep 5
          done
          
          echo "‚ùå $RETRIES deneme ba≈üarƒ±sƒ±z."
          exit 1