name: Frontend CI/CD Pipeline

on:
  push:
    branches: [ "main", "test" ]

env:
  IMAGE_NAME: frontend-repo
  DEPLOYMENT_NAME: frontend-app

jobs:
  build_and_push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Determine API URL
        id: vars
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
             echo "API_URL=${{ secrets.PROD_API_URL }}" >> $GITHUB_OUTPUT
          else
             echo "API_URL=${{ secrets.TEST_API_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          build-args: |
            VITE_API_URL=${{ steps.vars.outputs.API_URL }}

  deploy_test:
    name: Deploy to TEST with RETRY
    needs: build_and_push
    if: github.ref == 'refs/heads/test'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (Robust Retry Mode)
        run: |
          # 1. SSH Anahtarını Hazırla
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # 2. Değişkenleri Tanımla
          HOST="${{ secrets.SSH_HOST }}"
          USER="${{ secrets.SSH_USER }}"
          NAMESPACE="test"
          DOMAIN="test.yigithankarabulut.com"
          IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          DEPLOY_NAME="${{ env.DEPLOYMENT_NAME }}"

          # 3. Sunucuda Çalışacak Komutlar (EOF Bloğu)
          # Bu blok sunucuya tek seferde gönderilecek
          REMOTE_COMMANDS=$(cat <<EOF
            export PATH=\$PATH:/usr/local/bin:/usr/bin
            
            # Namespace Kontrolü
            kubectl get namespace $NAMESPACE > /dev/null 2>&1 || kubectl create namespace $NAMESPACE
            
            # Deployment Dosyasını Uygula
            cat <<YAML | kubectl apply -f -
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: $DEPLOY_NAME
              namespace: $NAMESPACE
              labels:
                app: $DEPLOY_NAME
            spec:
              replicas: 1
              selector:
                matchLabels:
                  app: $DEPLOY_NAME
              template:
                metadata:
                  labels:
                    app: $DEPLOY_NAME
                spec:
                  containers:
                  - name: frontend
                    image: $IMAGE
                    ports:
                    - containerPort: 80
            ---
            apiVersion: v1
            kind: Service
            metadata:
              name: $DEPLOY_NAME-service
              namespace: $NAMESPACE
            spec:
              selector:
                app: $DEPLOY_NAME
              ports:
                - protocol: TCP
                  port: 80
                  targetPort: 80
            ---
            apiVersion: networking.k8s.io/v1
            kind: Ingress
            metadata:
              name: $DEPLOY_NAME-ingress
              namespace: $NAMESPACE
            spec:
              rules:
              - host: $DOMAIN
                http:
                  paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: $DEPLOY_NAME-service
                        port:
                          number: 80
            YAML
            
            # Restart
            kubectl rollout restart deployment/$DEPLOY_NAME -n $NAMESPACE
          EOF
          )

          # 4. BAĞLANTI DÖNGÜSÜ (Retry Logic)
          # Connection Reset yersek 5 kere tekrar dener
          MAX_RETRIES=5
          COUNT=0
          SUCCESS=0
          
          while [ \$COUNT -lt \$MAX_RETRIES ]; do
            echo "Attempt \$((COUNT+1)) of \$MAX_RETRIES to connect to \$HOST..."
            
            # ssh komutu (StrictHostKeyChecking=no ile onayı atlar)
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa \$USER@\$HOST "\$REMOTE_COMMANDS"
            
            if [ \$? -eq 0 ]; then
              echo "✅ Deployment SUCCESS!"
              SUCCESS=1
              break
            else
              echo "⚠️ Connection failed or reset. Retrying in 10 seconds..."
              sleep 10
              COUNT=\$((COUNT+1))
            fi
          done

          if [ \$SUCCESS -eq 0 ]; then
            echo "❌ Failed to deploy after \$MAX_RETRIES attempts."
            exit 1
          fi

  deploy_prod:
    name: Deploy to PROD with RETRY
    needs: build_and_push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (Robust Retry Mode)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          HOST="${{ secrets.SSH_HOST }}"
          USER="${{ secrets.SSH_USER }}"
          NAMESPACE="prod"
          DOMAIN="yigithankarabulut.com"
          IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          DEPLOY_NAME="${{ env.DEPLOYMENT_NAME }}"

          REMOTE_COMMANDS=$(cat <<EOF
            export PATH=\$PATH:/usr/local/bin:/usr/bin
            
            kubectl get namespace $NAMESPACE > /dev/null 2>&1 || kubectl create namespace $NAMESPACE
            
            cat <<YAML | kubectl apply -f -
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: $DEPLOY_NAME
              namespace: $NAMESPACE
              labels:
                app: $DEPLOY_NAME
            spec:
              replicas: 2
              selector:
                matchLabels:
                  app: $DEPLOY_NAME
              template:
                metadata:
                  labels:
                    app: $DEPLOY_NAME
                spec:
                  containers:
                  - name: frontend
                    image: $IMAGE
                    ports:
                    - containerPort: 80
            ---
            apiVersion: v1
            kind: Service
            metadata:
              name: $DEPLOY_NAME-service
              namespace: $NAMESPACE
            spec:
              selector:
                app: $DEPLOY_NAME
              ports:
                - protocol: TCP
                  port: 80
                  targetPort: 80
            ---
            apiVersion: networking.k8s.io/v1
            kind: Ingress
            metadata:
              name: $DEPLOY_NAME-ingress
              namespace: $NAMESPACE
            spec:
              rules:
              - host: $DOMAIN
                http:
                  paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: $DEPLOY_NAME-service
                        port:
                          number: 80
            YAML
            
            kubectl rollout restart deployment/$DEPLOY_NAME -n $NAMESPACE
          EOF
          )

          MAX_RETRIES=5
          COUNT=0
          SUCCESS=0
          
          while [ \$COUNT -lt \$MAX_RETRIES ]; do
            echo "Attempt \$((COUNT+1)) of \$MAX_RETRIES to connect to \$HOST..."
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa \$USER@\$HOST "\$REMOTE_COMMANDS"
            if [ \$? -eq 0 ]; then
              echo "✅ Deployment SUCCESS!"
              SUCCESS=1
              break
            else
              echo "⚠️ Connection failed. Retrying in 10 seconds..."
              sleep 10
              COUNT=\$((COUNT+1))
            fi
          done

          if [ \$SUCCESS -eq 0 ]; then
            echo "❌ Failed after \$MAX_RETRIES attempts."
            exit 1
          fi